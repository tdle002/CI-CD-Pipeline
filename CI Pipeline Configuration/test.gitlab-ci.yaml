stages:
  - install
  - test
  - build
  - deploy

variables:
  # Adjust as per your project needs
  NODE_ENV: "production"
  FRONTEND_DIR: "frontend"
  BACKEND_DIR: "backend"
  DOCKER_IMAGE: "registry.gitlab.com/yourusername/yourproject"

cache:
  paths:
    - node_modules/

# ----------------------------
# Install dependencies
# ----------------------------
install_frontend:
  stage: install
  script:
    - echo "Installing frontend dependencies..."
    - cd $FRONTEND_DIR
    - npm install
  tags:
    - docker

install_backend:
  stage: install
  script:
    - echo "Installing backend dependencies..."
    - cd $BACKEND_DIR
    - npm install
  tags:
    - docker

# ----------------------------
# Run Tests
# ----------------------------
test_frontend:
  stage: test
  script:
    - echo "Running frontend tests..."
    - cd $FRONTEND_DIR
    - npm test -- --watchAll=false
  tags:
    - docker

test_backend:
  stage: test
  script:
    - echo "Running backend tests..."
    - cd $BACKEND_DIR
    - npm test
  tags:
    - docker

# ----------------------------
# Build Application
# ----------------------------
build_frontend:
  stage: build
  script:
    - echo "Building frontend..."
    - cd $FRONTEND_DIR
    - npm run build
  artifacts:
    paths:
      - $FRONTEND_DIR/build
  tags:
    - docker

build_backend:
  stage: build
  script:
    - echo "Building backend..."
    - cd $BACKEND_DIR
    - npm run build # optional, if you have a build step
  tags:
    - docker

# ----------------------------
# Deploy (example with Docker)
# ----------------------------
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to GitLab Container Registry..."
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG .
    - echo "Pushing Docker image..."
    - docker push $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG
    - echo "Deploying to server..."
    # Example: SSH deployment (needs CI/CD variables setup)
    - ssh $DEPLOY_USER@$DEPLOY_HOST "docker pull $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG && docker-compose up -d"
  only:
    - main
  tags:
    - docker
